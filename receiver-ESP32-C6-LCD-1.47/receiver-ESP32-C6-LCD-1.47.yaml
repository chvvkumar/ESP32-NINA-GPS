# Enable Home Assistant API
api:
  encryption:
    key: !secret c6_1.47_lcd_api_encryption_key

ota:
  - platform: esphome
    password: !secret c6_1.47_lcd_ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: none
  on_connect:
    - lambda: |-
        // Update WiFi MAC text sensor on connection
        uint8_t mac_bytes[6];
        esp_read_mac(mac_bytes, ESP_MAC_WIFI_STA);
        char mac_str[18];
        snprintf(mac_str, sizeof(mac_str), "%02X:%02X:%02X:%02X:%02X:%02X",
                 mac_bytes[0], mac_bytes[1], mac_bytes[2], mac_bytes[3], mac_bytes[4], mac_bytes[5]);
        id(wifi_mac_address).publish_state(mac_str);
  ap:
    ssid: "ESP32C6-LCD Fallback"
    password: !secret wifi_fallback_password
captive_portal:

web_server:
  port: 80
  version: 3
  include_internal: true

substitutions:
  id: esp32c6_lcd

esp32:
  board: esp32-c6-devkitc-1
  variant: esp32c6
  flash_size: 4MB
  framework:
    type: esp-idf
    version: recommended
    sdkconfig_options:
      CONFIG_ESPTOOLPY_FLASHSIZE_DETECT: y
      CONFIG_ESPTOOLPY_FLASHSIZE_4MB: y
      CONFIG_OPENTHREAD_ENABLED: n
      CONFIG_USE_MINIMAL_MDNS: y
      CONFIG_ESP_WIFI_ESPNOW_MAX_ENCRYPT_NUM: "7"
      COMPILER_OPTIMIZATION_SIZE: y
      COMPILER_OPTIMIZATION_LEVEL_RELEASE: y
      CONFIG_COMPILER_OPTIMIZATION_ASSERTIONS_DISABLE: y
      CONFIG_HEAP_POISONING_DISABLED: y

esphome:
  friendly_name: "ESP32-C6 1.47 LCD"
  name: esp32c6-lcd
  name_add_mac_suffix: false
  project:
    name: "Waveshare.ESP32-C6-LCD-1-47in"
    version: "1.0"
  platformio_options:
    board_build.partitions: huge_app.csv
    board_build.flash_mode: dio
    build_flags:
      - "-DI2C_NUM_1=I2C_NUM_0"
      - "-Wl,-Map,output.map"
      # REMOVED PSRAM FLAGS causing the boot loop
  
  on_boot:
    priority: 600
    then:
      - delay: 1s
      - light.turn_on:
          id: esp32c6_lcd_led
          brightness: !lambda "return id(idle_brightness).state / 100.0;"
          red: !lambda "return id(idle_red).state / 255.0;"
          green: !lambda "return id(idle_green).state / 255.0;"
          blue: !lambda "return id(idle_blue).state / 255.0;"
      - delay: 2s
      - lambda: |-
          // Initialize bar range from history for all pages
          int max_hist = (int)id(gps_max_sats).state;
          if (max_hist < 10) max_hist = 24; 
          
          // Safety check: ensure objects exist before calling LVGL
          if (id(lbl_sats_home) != nullptr) {
             lv_bar_set_range(id(lbl_sats_home), 0, max_hist);
             lv_obj_invalidate(id(lbl_sats_home));
          }
          if (id(lbl_sats_accuracy) != nullptr) {
             lv_bar_set_range(id(lbl_sats_accuracy), 0, max_hist);
             lv_obj_invalidate(id(lbl_sats_accuracy));
          }

      # Restore the last displayed LVGL page
      - delay: 500ms
      - if:
          condition:
            lambda: 'return id(display_page).has_state() && id(display_page).current_option() == "Home";'
          then:
            - lvgl.page.show: page_home
      - if:
          condition:
            lambda: 'return id(display_page).has_state() && id(display_page).current_option() == "GPS Accuracy";'
          then:
            - lvgl.page.show: page_accuracy
      - if:
          condition:
            lambda: 'return id(display_page).has_state() && id(display_page).current_option() == "Speed";'
          then:
            - lvgl.page.show: page_speed
      - if:
          condition:
            lambda: 'return id(display_page).has_state() && id(display_page).current_option() == "Network Info";'
          then:
            - lvgl.page.show: page_network

logger:

spi:
  clk_pin: GPIO7
  miso_pin: GPIO5
  mosi_pin: GPIO6

# RGB LED on GPIO8
light:
  - platform: esp32_rmt_led_strip
    id: "${id}_led"
    name: "Onboard LED"
    rgb_order: RGB
    pin: 
      number: GPIO8
      ignore_strapping_warning: true
    num_leds: 1
    chipset: SK6812
    internal: true
    default_transition_length: 10ms

  # Screen backlight as a light entity
  - platform: monochromatic
    id: screen_backlight
    name: "Screen Brightness"
    output: lcd_backlight
    default_transition_length: 0.3s
    restore_mode: RESTORE_DEFAULT_ON
    internal: false

output:
  - platform: ledc
    pin: GPIO22
    id: lcd_backlight
    frequency: 1000 Hz

button:
  - platform: restart
    name: "Reboot"
    internal: false

# =========================================================================
#  ESP-NOW CONFIGURATION
# =========================================================================
espnow:
  id: espnow_component
  auto_add_peer: true
  peers:
    - "10:B4:1D:EA:E0:68"
    - "B4:3A:45:99:70:80"
  on_unknown_peer:
    - lambda: |-
        // Update ESP-NOW MAC when peer is added
        uint8_t mac[6];
        esp_read_mac(mac, ESP_MAC_WIFI_STA);
        char mac_str[18];
        snprintf(mac_str, sizeof(mac_str), "%02X:%02X:%02X:%02X:%02X:%02X",
                 mac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);
        id(espnow_mac_address).publish_state(mac_str);
  
  on_receive:
    - lambda: |-
        struct __attribute__((packed)) GpsEspNowPacket {
          double lat;
          double lon;
          float alt;
          float speed;
          float heading;
          uint8_t sats;
          uint8_t satsVisible;
          uint8_t fixType;
          char localTime[10];
          float pdop;
          float hdop;
          float vdop;
          float hAcc;
          float vAcc;
          uint32_t stationIp;
          uint32_t pingCounter;
        };

        if (size != sizeof(GpsEspNowPacket)) {
          ESP_LOGW("espnow", "Received unexpected packet size: %d", size);
          return; 
        }
        
        GpsEspNowPacket packet;
        memcpy(&packet, data, sizeof(GpsEspNowPacket));
        
        ESP_LOGI("espnow", "Ping received #%u from sender", packet.pingCounter);
        
        id(g_gps_lat) = packet.lat;
        id(g_gps_lon) = packet.lon;
        id(g_gps_alt) = packet.alt;
        id(g_gps_speed) = packet.speed;
        id(g_gps_heading) = packet.heading;
        id(g_gps_sats) = packet.sats;
        id(g_gps_sats_visible) = packet.satsVisible;
        id(g_gps_fix_type) = packet.fixType;
        id(g_gps_hdop) = packet.hdop;
        id(g_gps_pdop) = packet.pdop;
        id(g_gps_vdop) = packet.vdop;
        id(g_gps_hacc) = packet.hAcc;
        id(g_gps_vacc) = packet.vAcc;
        
        // Copy raw bytes to char array buffer.
        memcpy(id(raw_local_time), packet.localTime, 10);
        id(raw_local_time)[10] = 0; 
        
        id(raw_station_ip) = packet.stationIp;
        id(last_ping_counter) = packet.pingCounter;
        id(g_gps_data_updated) = true;
    
    # Send pong response back to sender
    - espnow.send:
        address: !lambda |-
          std::array<uint8_t, 6> addr;
          std::copy(info.src_addr, info.src_addr + 6, addr.begin());
          return addr;
        data: !lambda |-
          struct __attribute__((packed)) PongPacket {
            uint32_t pingCounter;
          };
          PongPacket pong;
          pong.pingCounter = id(last_ping_counter);
          
          ESP_LOGI("espnow", "Sending pong response for ping #%u", pong.pingCounter);
          
          return std::vector<uint8_t>((uint8_t*)&pong, (uint8_t*)&pong + sizeof(PongPacket));
        id: espnow_component
        wait_for_sent: true
        continue_on_error: true

# =========================================================================
#  GLOBALS
# =========================================================================
globals:
  - id: last_ping_counter
    type: uint32_t
    restore_value: no
    initial_value: '0'
  
  - id: raw_local_time
    type: char[11]
    restore_value: no
  
  - id: raw_station_ip
    type: uint32_t
    restore_value: no
    initial_value: '0'

  - id: g_gps_lat
    type: double
    restore_value: no
    initial_value: '0.0'
  
  - id: g_gps_lon
    type: double
    restore_value: no
    initial_value: '0.0'
  
  - id: g_gps_alt
    type: float
    restore_value: no
    initial_value: '0.0'
  
  - id: g_gps_speed
    type: float
    restore_value: no
    initial_value: '0.0'
  
  - id: g_gps_heading
    type: float
    restore_value: no
    initial_value: '0.0'
  
  - id: g_gps_sats
    type: uint8_t
    restore_value: no
    initial_value: '0'
  
  - id: g_gps_sats_visible
    type: uint8_t
    restore_value: no
    initial_value: '0'
  
  - id: g_gps_fix_type
    type: uint8_t
    restore_value: no
    initial_value: '0'
  
  - id: g_gps_local_time
    type: std::string
    restore_value: no
    initial_value: '"--:--:--"'
  
  - id: g_gps_hdop
    type: float
    restore_value: no
    initial_value: '0.0'
  
  - id: g_gps_pdop
    type: float
    restore_value: no
    initial_value: '0.0'
  
  - id: g_gps_vdop
    type: float
    restore_value: no
    initial_value: '0.0'
  
  - id: g_gps_hacc
    type: float
    restore_value: no
    initial_value: '0.0'
  
  - id: g_gps_vacc
    type: float
    restore_value: no
    initial_value: '0.0'
  
  - id: g_gps_station_ip
    type: std::string
    restore_value: no
    initial_value: '"0.0.0.0"'
  
  - id: g_gps_data_updated
    type: bool
    restore_value: no
    initial_value: 'false'

# =========================================================================
#  INTERVAL
# =========================================================================
interval:
  - interval: 100ms
    then:
      - lambda: |-
          if (!id(g_gps_data_updated)) {
            return;
          }
          id(g_gps_data_updated) = false;
          
          // === SAFE STRING CONVERSION IN MAIN LOOP ===
          id(g_gps_local_time) = std::string(id(raw_local_time));
          
          uint8_t ip_bytes[4];
          ip_bytes[0] = (id(raw_station_ip) >> 0) & 0xFF;
          ip_bytes[1] = (id(raw_station_ip) >> 8) & 0xFF;
          ip_bytes[2] = (id(raw_station_ip) >> 16) & 0xFF;
          ip_bytes[3] = (id(raw_station_ip) >> 24) & 0xFF;
          char ip_buf[16];
          snprintf(ip_buf, sizeof(ip_buf), "%d.%d.%d.%d", ip_bytes[0], ip_bytes[1], ip_bytes[2], ip_bytes[3]);
          id(g_gps_station_ip) = std::string(ip_buf);
          
          char buf[64];
          
          // Publish to Home Assistant
          id(gps_lat).publish_state(id(g_gps_lat));
          id(gps_lon).publish_state(id(g_gps_lon));
          id(gps_alt).publish_state(id(g_gps_alt));
          id(gps_speed).publish_state(id(g_gps_speed));
          id(gps_heading).publish_state(id(g_gps_heading));
          id(gps_sats).publish_state(id(g_gps_sats));
          id(gps_sats_visible).publish_state(id(g_gps_sats_visible));
          id(gps_local_time).publish_state(id(g_gps_local_time));
          id(gps_station_ip).publish_state(id(g_gps_station_ip));
          id(gps_connection_status).publish_state("Connected");
          
          std::string status = "Unknown";
          if (id(g_gps_fix_type) == 0) status = "No Fix";
          else if (id(g_gps_fix_type) == 1) status = "Dead Reckoning";
          else if (id(g_gps_fix_type) == 2) status = "2D Fix";
          else if (id(g_gps_fix_type) == 3) status = "3D Fix";
          id(gps_fix_status).publish_state(status);
          
          // === LVGL Updates ===
          
          lv_led_on(id(lv_led_status));
          
          snprintf(buf, sizeof(buf), "%.5f", id(g_gps_lat));
          lv_label_set_text(id(lat_value), buf);
          
          snprintf(buf, sizeof(buf), "%.5f", id(g_gps_lon));
          lv_label_set_text(id(lon_value), buf);
          
          snprintf(buf, sizeof(buf), "%.1f m", id(g_gps_alt));
          lv_label_set_text(id(alt_value), buf);
          
          lv_label_set_text(id(lbl_time), id(g_gps_local_time).c_str());
          
          int current_sats = id(g_gps_sats);
          int visible_sats = id(g_gps_sats_visible);
          int max_sats = (int)id(gps_max_sats).state;
          
          if (visible_sats > max_sats) {
            max_sats = visible_sats;
            id(gps_max_sats).publish_state(max_sats);
          }
          
          int range_max = (visible_sats > 0 ? visible_sats : max_sats);
          if (range_max <= 0) range_max = 10;

          lv_bar_set_range(id(lbl_sats_home), 0, range_max);
          lv_bar_set_value(id(lbl_sats_home), current_sats, LV_ANIM_OFF);
          lv_obj_invalidate(id(lbl_sats_home));
          
          lv_bar_set_range(id(lbl_sats_accuracy), 0, range_max);
          lv_bar_set_value(id(lbl_sats_accuracy), current_sats, LV_ANIM_OFF);
          lv_obj_invalidate(id(lbl_sats_accuracy));
          
          lv_label_set_text(id(lbl_status_home), status.c_str());
          lv_label_set_text(id(lbl_status_accuracy), status.c_str());
          
          snprintf(buf, sizeof(buf), "%d/%d", current_sats, visible_sats);
          lv_label_set_text(id(sat_status_home), buf);
          lv_label_set_text(id(sat_status_accuracy), buf);
          
          snprintf(buf, sizeof(buf), "%.1f m", id(g_gps_hacc));
          lv_label_set_text(id(value_hacc), buf);
          
          snprintf(buf, sizeof(buf), "%.1f m", id(g_gps_vacc));
          lv_label_set_text(id(value_vacc), buf);
          
          const char* directions[] = {"N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", 
                                       "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"};
          int dir_index = (int)((id(g_gps_heading) + 11.25) / 22.5) % 16;
          if (dir_index < 0) dir_index = 0; 
          if (dir_index > 15) dir_index = 0;

          snprintf(buf, sizeof(buf), "%.0f° %s", id(g_gps_heading), directions[dir_index]);
          lv_label_set_text(id(value_hdg), buf);
          lv_label_set_text(id(lbl_heading_speed), buf);
          
          snprintf(buf, sizeof(buf), "%.2f", id(g_gps_hdop));
          lv_label_set_text(id(val_hdop), buf);
          
          snprintf(buf, sizeof(buf), "%.2f", id(g_gps_pdop));
          lv_label_set_text(id(val_pdop), buf);
          
          snprintf(buf, sizeof(buf), "%.2f", id(g_gps_vdop));
          lv_label_set_text(id(val_vdop), buf);
          
          float speed_mph = id(g_gps_speed) * 2.23694;
          snprintf(buf, sizeof(buf), "%.1f", speed_mph);
          lv_label_set_text(id(val_speed), buf);
          lv_bar_set_value(id(bar_speed), (int)speed_mph, LV_ANIM_OFF);
          
          lv_label_set_text(id(value_gps_ip), id(g_gps_station_ip).c_str());
          
          id(espnow_blink_alert).execute();

  - interval: 500ms
    then:
      - lambda: |-
          if (!id(g_gps_data_updated)) {
            lv_led_off(id(lv_led_status));
          }

sensor:
  - platform: homeassistant
    id: outdoor_temp
    entity_id: sensor.outdoor_temperature
    internal: true

  - platform: template
    id: gps_lat
    name: "GPS Latitude"
    accuracy_decimals: 7
    internal: true

  - platform: template
    id: gps_lon
    name: "GPS Longitude"
    accuracy_decimals: 7
    internal: true

  - platform: template
    id: gps_alt
    name: "GPS Altitude"
    unit_of_measurement: "m"
    accuracy_decimals: 1
    internal: true

  - platform: template
    id: gps_speed
    name: "GPS Speed"
    unit_of_measurement: "m/s"
    accuracy_decimals: 1
    internal: true

  - platform: template
    id: gps_heading
    name: "GPS Heading"
    unit_of_measurement: "°"
    accuracy_decimals: 0
    internal: true

  - platform: template
    id: gps_sats
    name: "GPS Satellites"
    accuracy_decimals: 0
    internal: true

  - platform: template
    id: gps_sats_visible
    name: "GPS Satellites Visible"
    accuracy_decimals: 0
    internal: true

  - platform: wifi_signal
    name: "WiFi Signal"
    internal: true

text_sensor:
  - platform: wifi_info
    mac_address:
      name: "ESP MAC Address"
    ip_address:
      name: "ESP IP Address"
      id: wifi_ip_address
      internal: true
      on_value:
        then:
          - lambda: |-
              if (x.length() > 0) {
                 lv_label_set_text(id(value_receiver_ip), x.c_str());
              }

  - platform: template
    id: gps_local_time
    name: "GPS Local Time"
    internal: true

  - platform: template
    id: gps_fix_status
    name: "GPS Fix Status"
    internal: true
  
  - platform: template
    id: gps_station_ip
    name: "GPS Station IP"
    internal: true
  
  - platform: template
    id: gps_connection_status
    name: "GPS Connection Status"
    internal: true
  
  - platform: template
    id: wifi_mac_address
    name: "WiFi MAC Address"
    internal: false
  
  - platform: template
    id: espnow_mac_address
    name: "ESP-NOW MAC Address"
    internal: false

number:
  - platform: template
    name: "Max Satellites History"
    id: gps_max_sats
    optimistic: true
    min_value: 10
    max_value: 100
    step: 1
    initial_value: 24
    restore_value: true
    mode: box
    internal: true

  - platform: template
    name: "LED Blink Duration"
    id: led_blink_duration
    min_value: 100
    max_value: 2000
    step: 100
    initial_value: 500
    unit_of_measurement: "ms"
    optimistic: true
    restore_value: true
    mode: box
    internal: true

  - platform: template
    name: "Alert Brightness"
    id: blink_brightness
    optimistic: true
    min_value: 0
    max_value: 100
    step: 1
    initial_value: 100
    restore_value: true
    mode: slider
    internal: true

  - platform: template
    name: "Alert Color Red"
    id: blink_red
    optimistic: true
    min_value: 0
    max_value: 255
    step: 1
    initial_value: 0
    restore_value: true
    mode: box
    internal: true

  - platform: template
    name: "Alert Color Green"
    id: blink_green
    optimistic: true
    min_value: 0
    max_value: 255
    step: 1
    initial_value: 255
    restore_value: true
    mode: box
    internal: true

  - platform: template
    name: "Alert Color Blue"
    id: blink_blue
    optimistic: true
    min_value: 0
    max_value: 255
    step: 1
    initial_value: 0
    restore_value: true
    mode: box
    internal: true

  - platform: template
    name: "Alert Duration (ms)"
    id: blink_duration
    optimistic: true
    min_value: 50
    max_value: 2000
    step: 10
    initial_value: 100
    restore_value: true
    mode: box
    internal: true

  - platform: template
    name: "Idle Brightness"
    id: idle_brightness
    optimistic: true
    min_value: 0
    max_value: 100
    step: 1
    initial_value: 10
    restore_value: true
    mode: slider
    internal: true
    on_value:
      then:
        - if:
            condition:
              not:
                script.is_running: espnow_blink_alert
            then:
              - light.turn_on:
                  id: esp32c6_lcd_led
                  brightness: !lambda "return x / 100.0;"
                  red: !lambda "return id(idle_red).state / 255.0;"
                  green: !lambda "return id(idle_green).state / 255.0;"
                  blue: !lambda "return id(idle_blue).state / 255.0;"

  - platform: template
    name: "Idle Color Red"
    id: idle_red
    optimistic: true
    min_value: 0
    max_value: 255
    step: 1
    initial_value: 255
    restore_value: true
    mode: box
    internal: true
    on_value:
      then:
        - if:
            condition:
              not:
                script.is_running: espnow_blink_alert
            then:
              - light.turn_on:
                  id: esp32c6_lcd_led
                  brightness: !lambda "return id(idle_brightness).state / 100.0;"
                  red: !lambda "return x / 255.0;"
                  green: !lambda "return id(idle_green).state / 255.0;"
                  blue: !lambda "return id(idle_blue).state / 255.0;"

  - platform: template
    name: "Idle Color Green"
    id: idle_green
    optimistic: true
    min_value: 0
    max_value: 255
    step: 1
    initial_value: 0
    restore_value: true
    mode: box
    internal: true
    on_value:
      then:
        - if:
            condition:
              not:
                script.is_running: espnow_blink_alert
            then:
              - light.turn_on:
                  id: esp32c6_lcd_led
                  brightness: !lambda "return id(idle_brightness).state / 100.0;"
                  red: !lambda "return id(idle_red).state / 255.0;"
                  green: !lambda "return x / 255.0;"
                  blue: !lambda "return id(idle_blue).state / 255.0;"

  - platform: template
    name: "Idle Color Blue"
    id: idle_blue
    optimistic: true
    min_value: 0
    max_value: 255
    step: 1
    initial_value: 0
    restore_value: true
    mode: box
    internal: true
    on_value:
      then:
        - if:
            condition:
              not:
                script.is_running: espnow_blink_alert
            then:
              - light.turn_on:
                  id: esp32c6_lcd_led
                  brightness: !lambda "return id(idle_brightness).state / 100.0;"
                  red: !lambda "return id(idle_red).state / 255.0;"
                  green: !lambda "return id(idle_green).state / 255.0;"
                  blue: !lambda "return x / 255.0;"

script:
  - id: espnow_blink_alert
    mode: restart
    then:
      - light.turn_on:
          id: esp32c6_lcd_led
          brightness: !lambda "return id(blink_brightness).state / 100.0;"
          red: !lambda "return id(blink_red).state / 255.0;"
          green: !lambda "return id(blink_green).state / 255.0;"
          blue: !lambda "return id(blink_blue).state / 255.0;"
      
      - delay: !lambda "return id(blink_duration).state;"
      
      - light.turn_on:
          id: esp32c6_lcd_led
          brightness: !lambda "return id(idle_brightness).state / 100.0;"
          red: !lambda "return id(idle_red).state / 255.0;"
          green: !lambda "return id(idle_green).state / 255.0;"
          blue: !lambda "return id(idle_blue).state / 255.0;"

select:
  - platform: template
    name: "Display Rotation"
    id: display_rotation
    options: ["90°", "270°"]
    initial_option: "270°" 
    optimistic: true
    restore_value: true
    on_value:
      then:
        - lambda: |-
            auto rotation = esphome::display::DISPLAY_ROTATION_270_DEGREES;
            if (x == "90°") rotation = esphome::display::DISPLAY_ROTATION_90_DEGREES;
            else if (x == "270°") rotation = esphome::display::DISPLAY_ROTATION_270_DEGREES;
            id(tft_ha).set_rotation(rotation);
        - if:
            condition:
              lambda: 'return millis() > 15000;'
            then:
              - delay: 500ms
              - lambda: App.safe_reboot();

  - platform: template
    name: "Display Page"
    id: display_page
    options:
      - "Home"
      - "GPS Accuracy"
      - "Speed"
      - "Network Info"
    initial_option: "Home"
    optimistic: true
    restore_value: true
    on_value:
      then:
        - if:
            condition:
              lambda: 'return x == "Home";'
            then:
              - lvgl.page.show: page_home
        - if:
            condition:
              lambda: 'return x == "GPS Accuracy";'
            then:
              - lvgl.page.show: page_accuracy
        - if:
            condition:
              lambda: 'return x == "Speed";'
            then:
              - lvgl.page.show: page_speed
        - if:
            condition:
              lambda: 'return x == "Network Info";'
            then:
              - lvgl.page.show: page_network

# -------------------------------------------------------------------------
# LVGL CONFIGURATION
# -------------------------------------------------------------------------
lvgl:
  pages:
    - id: page_home
      bg_color: 0x000000
      widgets:
        - bar:
            id: lbl_sats_home
            x: 0
            y: 0
            width: 316
            height: 5
            value: 25
            min_value: 0
            max_value: 50
            indicator:
              bg_color: 0xE10522
            bg_color: 0x300707

        - led:
            id: lv_led_status
            x: 290
            y: 10
            width: 20
            height: 20
            color: 0xFF0000
            brightness: 21%

        - label:
            id: lbl_status_home
            x: 1
            y: 10
            height: 25
            text: "3D Fix"
            text_color: 0xE10522
            text_align: LEFT
            long_mode: SCROLL
            text_font: montserrat_20

        - label:
            id: sat_status_home
            x: 200
            y: 10
            height: 25
            text: "00/00"
            text_color: 0xE10522
            text_align: RIGHT
            long_mode: DOT
            text_font: montserrat_20

        - label:
            id: lbl_time
            x: 87
            y: 8
            text: "00:00:00"
            text_color: 0xE10522
            text_align: CENTER
            long_mode: CLIP
            text_font: montserrat_24

        - line:
            id: lv_line_home
            x: 0
            y: 30
            width: 320
            height: 10
            points:
              - 5, 5
              - 315, 5
            line_color: 0xB2061D
            line_rounded: true

        - label:
            id: lbl_lat
            x: 1
            y: 45
            height: 35
            text: "LAT:"
            text_color: 0xE10522
            long_mode: CLIP
            text_font: montserrat_32

        - label:
            id: lat_value
            x: 100
            y: 45
            height: 35
            text: "00.00000"
            text_color: 0xE10522
            text_align: RIGHT
            long_mode: DOT
            text_font: montserrat_32

        - label:
            id: lbl_lon
            x: 1
            y: 85
            height: 35
            text: "LON:"
            text_color: 0xE10522
            long_mode: CLIP
            text_font: montserrat_32

        - label:
            id: lon_value
            x: 100
            y: 85
            height: 35
            text: "-00.00000"
            text_color: 0xE10522
            text_align: RIGHT
            long_mode: CLIP
            text_font: montserrat_32

        - label:
            id: lbl_alt
            x: 1
            y: 130
            height: 30
            text: "ALT:"
            text_color: 0xE10522
            long_mode: CLIP
            text_font: montserrat_28

        - label:
            id: alt_value
            x: 186
            y: 130
            height: 30
            text: "000.0 m"
            text_color: 0xE10522
            text_align: RIGHT
            long_mode: CLIP
            text_font: montserrat_28

    - id: page_accuracy
      bg_color: 0x000000
      widgets:
        - bar:
            id: lbl_sats_accuracy
            x: 0
            y: 0
            width: 316
            height: 5
            value: 25
            min_value: 0
            max_value: 50
            indicator:
              bg_color: 0xE10522
            bg_color: 0x300707

        - label:
            id: lbl_status_accuracy
            x: 1
            y: 10
            height: 25
            text: "3D Fix"
            text_color: 0xE10522
            text_align: LEFT
            long_mode: SCROLL
            text_font: montserrat_20

        - label:
            id: sat_status_accuracy
            x: 230
            y: 10
            height: 25
            text: "00/00"
            text_color: 0xE10522
            text_align: RIGHT
            long_mode: DOT
            text_font: montserrat_20

        - label:
            id: lbl_hacc
            x: 2
            y: 40
            height: 20
            text: "H.Acc"
            text_color: 0xE10522
            long_mode: CLIP
            text_font: montserrat_16

        - label:
            id: lbl_vacc
            x: 115
            y: 40
            height: 20
            text: "V.Acc"
            text_color: 0xE10522
            text_align: CENTER
            long_mode: CLIP
            text_font: montserrat_16

        - label:
            id: lbl_hdg
            x: 230
            y: 40
            height: 20
            text: "Hdg."
            text_color: 0xE10522
            text_align: RIGHT
            long_mode: CLIP
            text_font: montserrat_16

        - label:
            id: value_hacc
            x: 0
            y: 60
            height: 25
            text: "00.0 m"
            text_color: 0xE10522
            long_mode: CLIP
            text_font: montserrat_24

        - label:
            id: value_vacc
            x: 105
            y: 60
            height: 25
            text: "0.0 m"
            text_color: 0xE10522
            text_align: CENTER
            long_mode: CLIP
            text_font: montserrat_24

        - label:
            id: value_hdg
            x: 220
            y: 60
            height: 25
            text: "000° NNE"
            text_color: 0xE10522
            text_align: RIGHT
            text_font: montserrat_16

        - line:
            id: lv_line_accuracy
            x: 0
            y: 88
            width: 320
            height: 10
            points:
              - 10, 5
              - 310, 5
            line_color: 0xE10522

        - label:
            id: lbl_hdop
            x: 0
            y: 140
            height: 20
            text: "HDOP"
            text_color: 0xE10522
            long_mode: CLIP
            text_font: montserrat_16

        - label:
            id: lbl_pdop
            x: 130
            y: 140
            height: 20
            text: "PDOP"
            text_color: 0xE10522
            text_align: CENTER
            long_mode: CLIP
            text_font: montserrat_16

        - label:
            id: lbl_vdop
            x: 260
            y: 140
            height: 20
            text: "VDOP"
            text_color: 0xE10522
            text_align: RIGHT
            long_mode: CLIP
            text_font: montserrat_16

        - label:
            id: val_hdop
            x: 0
            y: 110
            height: 28
            text: "0.00"
            text_color: 0xE10522
            long_mode: CLIP
            text_font: montserrat_24

        - label:
            id: val_pdop
            x: 130
            y: 110
            height: 28
            text: "0.00"
            text_color: 0xE10522
            text_align: CENTER
            long_mode: CLIP
            text_font: montserrat_24

        - label:
            id: val_vdop
            x: 250
            y: 110
            height: 28
            text: "0.00"
            text_color: 0xE10522
            text_align: RIGHT
            long_mode: CLIP
            text_font: montserrat_24

    - id: page_speed
      bg_color: 0x000000
      widgets:
        - label:
            id: val_speed
            x: 0
            y: 10
            width: 320
            height: 60
            text: "0.0"
            text_color: 0xE10522
            text_align: CENTER
            long_mode: DOT
            text_font: montserrat_48

        - label:
            id: lbl_speed_unit
            x: 0
            y: 65
            width: 320
            text: "mph"
            text_color: 0xE10522
            text_align: CENTER
            text_font: montserrat_20

        - bar:
            id: bar_speed
            x: 0
            y: 95
            width: 320
            height: 12
            value: 45
            min_value: 0
            max_value: 80
            indicator:
              bg_color: 0x9F0419
            bg_color: 0x1F2937

        - label:
            id: lbl_heading_speed
            x: 0
            y: 120
            width: 320
            text: "000° SSW"
            text_color: 0xE10522
            text_align: CENTER
            text_font: montserrat_28

    - id: page_network
      bg_color: 0x000000
      widgets:
        - label:
            id: lbl_network_title
            x: 0
            y: 2
            width: 320
            text: "Network Info"
            text_color: 0xE10522
            text_align: CENTER
            text_font: montserrat_28

        - line:
            id: lv_line_network
            x: 0
            y: 32
            width: 320
            height: 10
            points:
              - 10, 5
              - 310, 5
            line_color: 0xB2061D
            line_rounded: true

        - label:
            id: lbl_gps_ip_title
            x: 0
            y: 50
            height: 25
            text: "GPS Station"
            text_color: 0xE10522
            long_mode: CLIP
            text_font: montserrat_20

        - label:
            id: value_gps_ip
            x: 0
            y: 75
            width: 320
            height: 30
            text: "0.0.0.0"
            text_color: 0xE10522
            text_align: CENTER
            long_mode: CLIP
            text_font: montserrat_28

        - label:
            id: lbl_receiver_ip_title
            x: 0
            y: 110
            height: 25
            text: "This Device"
            text_color: 0xE10522
            long_mode: CLIP
            text_font: montserrat_20

        - label:
            id: value_receiver_ip
            x: 0
            y: 135
            width: 320
            height: 30
            text: "0.0.0.0"
            text_color: 0xE10522
            text_align: CENTER
            long_mode: CLIP
            text_font: montserrat_28

  buffer_size: 10%
  displays:
    - tft_ha

# -------------------------------------------------------------------------
# DISPLAY DRIVER
# -------------------------------------------------------------------------
display:
  - platform: st7789v
    cs_pin: GPIO14
    dc_pin:
      number: GPIO15
      ignore_strapping_warning: true
    reset_pin: GPIO21
    model: Waveshare 1.47in 172X320
    id: tft_ha
    rotation: 270

# -------------------------------------------------------------------------
# FONTS - CORRECTED IDs to match widgets
# -------------------------------------------------------------------------
font:
  - file: "gfonts://Roboto"
    id: montserrat_16
    size: 16
    glyphs: "0123456789.-%ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz :°/"
  - file: "gfonts://Roboto"
    id: montserrat_20
    size: 20
    glyphs: "0123456789.-%ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz :°/"
  - file: "gfonts://Roboto"
    id: montserrat_24
    size: 24
    glyphs: "0123456789.-%ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz :°/"
  - file: "gfonts://Roboto"
    id: montserrat_28
    size: 28
    glyphs: "0123456789.-%ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz :°/"
  - file: "gfonts://Roboto"
    id: montserrat_32
    size: 32
    glyphs: "0123456789.-%ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz :°/"
  - file: "gfonts://Roboto"
    id: montserrat_48
    size: 48
    glyphs: "0123456789.-%ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz :°/"
